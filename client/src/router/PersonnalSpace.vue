<template>
  <div class="container-fluid">
    <div class="center">
      <b-button variant="dark" @click="goToEdit($root.user._id)">Editer profil</b-button>
      <b-button variant="dark" @click="goToTimeWork($root.user._id)">Saisie présences</b-button>
      <b-button variant="dark" @click="goToAbsences($root.user._id)">Saisie des absences</b-button>
      <b-button variant="dark" @click="goToRequestVacation($root.user._id)">Demande de congés</b-button>
    </div>
    <div class="d-flex justify-content-center">
      <div class="card" style="width: 20rem;">
        <div v-if="$root.user._id === user._id">
          <form @submit.prevent = "uploadPicture">
            <img :src="user.profilePic" class="img-thumbnail">
            <input type="file" name="image" @change="onFileChange">
            <b-button variant="dark" @click.prevent="edit()">Sauvegarder photo</b-button>
          </form>
        </div>
        <img :src="image" />
        <div class="card-block">
          <h4 class="card-title">Données personnelles</h4>
        </div>
        <ul class="list-group list-group-flush">
          <li class="list-group-item"><strong>Nom prénom : </strong> {{user.firstname}} {{user.lastname}} </li>
          <li class="list-group-item"><strong>Email  : </strong> {{user.email}} </li>
          <li class="list-group-item"><strong>Téléphone  : </strong> {{user.telNumber}} </li>
          <li class="list-group-item"><strong>Adresse  : </strong> {{user.address}}, {{user.codePostal}}, {{user.city}} </li>
        </ul>
        <br>
        <h4 class="card-title">Données Professionnel</h4>
        <ul class="list-group list-group-flush">
          <li class="list-group-item"><strong>Email pro : </strong> {{user.professionalEmail}} </li>
          <li class="list-group-item"><strong>Téléphone perso : </strong> {{user.professionalNumber}} </li>
        </ul>
      </div>
    </div>
  </div>
</template>

<script>
import axios from "axios";
import { checkUser } from "@/api/auth";
import { getSingleUser, editUser } from "@/api/users";
export default {
  data() {
    return {
      user: true,
      image: ""
    };
  },
  methods: {
    onFileChange(e) {
      let files = e.target.files || e.dataTransfer.files;
      if (!files.length) return;
      this.createImage(files[0]);
    },
    createImage(file) {
      let image = new Image();
      let reader = new FileReader();
      let vm = this;

      reader.onload = e => {
        vm.image = e.target.result;
      };
      reader.readAsDataURL(file);
    },
    uploadPicture() {
      const formData = new FormData();
      formData.append("image", this.image);
      axios
        .post("http://localhost:3000/api/images/upload", formData, {
          headers: {
            "Content-Type": "multipart/form-data"
          }
        })
        .then(response => {
          this.image = response.data.secure_url;
        });
    },
    edit() {
      editUser(this.$root.user._id, { profilePic: this.image });
    },
    goToEdit(id) {
      this.$router.push("/perso/" + id);
    },
    goToTimeWork(id) {
      this.$router.push("/perso/" + id + "/time-work");
    },
    goToRequestVacation(id) {
      this.$router.push("/perso/" + id + "/vacation");
    },
    goToAbsences(id) {
      this.$router.push("/perso/" + id + "/absence");
    }
  },
  created() {
    checkUser(this.$root);
    if (!this.$root.user) this.$router.push("/404");
    getSingleUser(this.$root.user._id).then(user => {
      this.user = user;
    });
  }
};
</script>

<style scoped>
.center {
  margin-left: 28%;
}
</style>
